--[[
Changelog v2.3 (Fokus Performa Mobile):
- [PERFORMA] Implementasi "GUI Object Pooling". Tombol pemain dibuat sekali dan didaur ulang, bukan dihancurkan dan dibuat ulang. Ini secara drastis mengurangi beban CPU.
- [PERFORMA] Sistem update dipecah menjadi dua:
    - "Full Update": Menyaring & mengurutkan ulang daftar, hanya berjalan saat ada perubahan (pencarian, pemain join/leave).
    - "Light Update": Berjalan periodik, HANYA memperbarui status (online/offline) pada tombol yang sudah terlihat. Jauh lebih ringan.
- [PERFORMA] Koneksi event (klik tombol) dibuat sekali per tombol, bukan di setiap update, mengurangi overhead.
- [OPTIMASI] Interval auto-refresh disesuaikan karena tugasnya sekarang lebih ringan.
- [KODE] Penggunaan Attributes (`SetAttribute`) untuk menyimpan data pemain di setiap tombol, cara yang modern dan efisien.
]]

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

--// Variables
local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local searchDebounceTime = 0.2 -- Sedikit lebih lama untuk mengurangi panggilan di mobile
local searchDebounceThread = nil
local teleportCooldown = false
local lastSearchQuery = nil
local updateLoopThread = nil
local playerButtonPool = {} -- [PERFORMA] Kolam untuk tombol pemain

--// Configuration
local CONFIG = {
    TELEPORT_OFFSET = Vector3.new(0, 3, 0),
    RANDOM_HORIZONTAL_OFFSET = 1.5,
    MAX_TELEPORT_ATTEMPTS = 5,
    TELEPORT_RETRY_DELAY = 0.25,
    COOLDOWN_TIME = 1,
    LIGHT_REFRESH_INTERVAL = 3, -- [OPTIMASI] Interval untuk update ringan
    POST_TELEPORT_VERIFICATION_DISTANCE = 75,
    MAX_PLAYER_BUTTONS = 60, -- [PERFORMA] Jumlah maksimum tombol yang dibuat di awal
}

--// GUI Creation (Sama seperti v2.2)
local ScreenGui = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
-- ... (Semua kode pembuatan GUI dari v2.2 tetap sama, tidak perlu disalin ulang di sini untuk keringkasan) ...
-- Anggap semua elemen GUI dari v2.2 sudah ada di sini
ScreenGui.Name = "AdvancedTeleportGUI_v2.3"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
MainFrame.Name = "MainFrame"
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
MainFrame.Position = UDim2.new(0.5, -140, 0.5, -160)
MainFrame.Size = UDim2.new(0, 280, 0, 320)
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Visible = true
local UICorner = Instance.new("UICorner", MainFrame)
UICorner.CornerRadius = UDim.new(0, 8)
local Title = Instance.new("TextLabel", MainFrame)
Title.Name = "Title"
Title.BackgroundTransparency = 1
Title.Position = UDim2.new(0, 0, 0.02, 0)
Title.Size = UDim2.new(1, 0, 0.08, 0)
Title.Font = Enum.Font.GothamBold
Title.Text = "üöÄ Adv Teleport v2.3"
Title.TextColor3 = Color3.fromRGB(100, 200, 255)
Title.TextSize = 16
local SearchBox = Instance.new("TextBox", MainFrame)
SearchBox.Name = "SearchBox"
SearchBox.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
SearchBox.Position = UDim2.new(0.05, 0, 0.12, 0)
SearchBox.Size = UDim2.new(0.75, 0, 0.09, 0)
SearchBox.Font = Enum.Font.Gotham
SearchBox.PlaceholderText = "üîç Cari pemain..."
SearchBox.TextColor3 = Color3.fromRGB(255, 255, 255)
SearchBox.TextSize = 13
SearchBox.ClearTextOnFocus = true
local searchBoxCorner = Instance.new("UICorner", SearchBox)
searchBoxCorner.CornerRadius = UDim.new(0, 6)
local RefreshButton = Instance.new("TextButton", MainFrame)
RefreshButton.Name = "RefreshButton"
RefreshButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
RefreshButton.Position = UDim2.new(0.82, 0, 0.12, 0)
RefreshButton.Size = UDim2.new(0.13, 0, 0.09, 0)
RefreshButton.Font = Enum.Font.GothamBold
RefreshButton.Text = "üîÑ"
RefreshButton.TextColor3 = Color3.fromRGB(255, 255, 255)
RefreshButton.TextSize = 16
local refreshBtnCorner = Instance.new("UICorner", RefreshButton)
refreshBtnCorner.CornerRadius = UDim.new(0, 6)
local PlayerList = Instance.new("ScrollingFrame", MainFrame)
PlayerList.Name = "PlayerList"
PlayerList.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
PlayerList.Position = UDim2.new(0.05, 0, 0.23, 0)
PlayerList.Size = UDim2.new(0.9, 0, 0.52, 0)
PlayerList.ScrollBarThickness = 6
PlayerList.BorderSizePixel = 0
local playerListCorner = Instance.new("UICorner", PlayerList)
playerListCorner.CornerRadius = UDim.new(0, 8)
local UIListLayout = Instance.new("UIListLayout", PlayerList)
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Padding = UDim.new(0, 3)
local TeleportButton = Instance.new("TextButton", MainFrame)
TeleportButton.Name = "TeleportButton"
TeleportButton.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
TeleportButton.Position = UDim2.new(0.05, 0, 0.77, 0)
TeleportButton.Size = UDim2.new(0.9, 0, 0.11, 0)
TeleportButton.Font = Enum.Font.GothamBold
TeleportButton.Text = "üéØ TELEPORT"
TeleportButton.TextColor3 = Color3.fromRGB(255, 255, 255)
TeleportButton.TextSize = 15
local teleportBtnCorner = Instance.new("UICorner", TeleportButton)
teleportBtnCorner.CornerRadius = UDim.new(0, 8)
local StatusLabel = Instance.new("TextLabel", MainFrame)
StatusLabel.Name = "StatusLabel"
StatusLabel.BackgroundTransparency = 1
StatusLabel.Position = UDim2.new(0.05, 0, 0.89, 0)
StatusLabel.Size = UDim2.new(0.9, 0, 0.1, 0)
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.Text = "‚úÖ GUI siap."
StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
StatusLabel.TextSize = 12
StatusLabel.TextWrapped = true
StatusLabel.TextYAlignment = Enum.TextYAlignment.Top
ScreenGui.Parent = PlayerGui

--// Utility Functions (Fungsi ValidateCharacter & ShowStatus tetap sama)
local function ShowStatus(message, color, duration, isError)
    local prefix = isError and "‚ùå " or (color == Color3.fromRGB(100, 255, 100) and "‚úÖ " or "‚ÑπÔ∏è ")
    StatusLabel.Text = prefix .. message
    StatusLabel.TextColor3 = color or Color3.fromRGB(255, 255, 255)
    task.delay(duration or 4, function()
        if StatusLabel and StatusLabel.Text == (prefix .. message) then
            StatusLabel.Text = "‚è≥ Menunggu aksi..."
            StatusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
        end
    end)
end

local function ValidateCharacter(character)
    if not character or not character.Parent then return false end
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid or humanoid.Health <= 0 or humanoid:GetState() == Enum.HumanoidStateType.Dead then return false end
    if not character:FindFirstChild("HumanoidRootPart") then return false end
    return true, humanoid
end

--// [PERFORMA] Fungsi untuk membuat kolam tombol di awal
local function PreCreatePlayerButtons()
    for i = 1, CONFIG.MAX_PLAYER_BUTTONS do
        local playerButton = Instance.new("TextButton")
        playerButton.Size = UDim2.new(1, -8, 0, 28)
        playerButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        playerButton.TextSize = 12
        playerButton.Font = Enum.Font.Gotham
        playerButton.TextXAlignment = Enum.TextXAlignment.Left
        playerButton.Visible = false -- Sembunyikan secara default
        playerButton.Parent = PlayerList
        
        local btnCorner = Instance.new("UICorner", playerButton)
        btnCorner.CornerRadius = UDim.new(0, 6)
        
        -- [PERFORMA] Koneksi event dibuat sekali saja
        playerButton.MouseButton1Click:Connect(function()
            local targetPlayer = playerButton:GetAttribute("TargetPlayer")
            if targetPlayer then
                SearchBox.Text = targetPlayer.Name
                local isValid, _ = ValidateCharacter(targetPlayer.Character)
                ShowStatus(string.format("Target: %s (%s)", targetPlayer.DisplayName, isValid and "Ready" or "Not Ready"), Color3.fromRGB(150, 200, 255), 2)
            end
        end)
        
        table.insert(playerButtonPool, playerButton)
    end
end

--// [PERFORMA] Fungsi Update Penuh (Full Update)
local function FullUpdatePlayerList(searchText)
    local currentSearchText = searchText or ""
    if currentSearchText == lastSearchQuery and currentSearchText ~= "" then return end
    lastSearchQuery = currentSearchText
    
    local lowerSearchText = currentSearchText:lower()
    
    -- Kumpulkan dan saring data pemain
    local playersToShow = {}
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= Player then
            local name = p.Name:lower()
            local displayName = p.DisplayName:lower()
            if lowerSearchText == "" or name:match(lowerSearchText) or displayName:match(lowerSearchText) then
                table.insert(playersToShow, p)
            end
        end
    end

    -- Urutkan data pemain
    table.sort(playersToShow, function(a, b)
        local aIsValid, _ = ValidateCharacter(a.Character)
        local bIsValid, _ = ValidateCharacter(b.Character)
        if aIsValid ~= bIsValid then return aIsValid end
        return a.DisplayName:lower() < b.DisplayName:lower()
    end)

    -- Sembunyikan semua tombol di kolam terlebih dahulu
    for _, button in ipairs(playerButtonPool) do
        button.Visible = false
        button:SetAttribute("TargetPlayer", nil)
    end

    -- Gunakan tombol dari kolam untuk menampilkan pemain
    for i, p in ipairs(playersToShow) do
        if i > CONFIG.MAX_PLAYER_BUTTONS then break end -- Jangan melebihi kapasitas kolam
        
        local button = playerButtonPool[i]
        local isValid, _ = ValidateCharacter(p.Character)
        local statusIcon = isValid and "üü¢" or "üî¥"
        
        button.Text = string.format("%s %s (@%s)", statusIcon, p.DisplayName, p.Name)
        button.BackgroundColor3 = isValid and Color3.fromRGB(45, 70, 45) or Color3.fromRGB(70, 45, 45)
        button:SetAttribute("TargetPlayer", p) -- Simpan referensi pemain
        button.Visible = true
    end
    
    PlayerList.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y + 10)
end

--// [PERFORMA] Fungsi Update Ringan (Light Update)
local function LightUpdatePlayerStatus()
    if not MainFrame.Visible then return end -- Jangan update jika GUI tidak terlihat

    local needsLayoutUpdate = false
    for _, button in ipairs(playerButtonPool) do
        if button.Visible then
            local p = button:GetAttribute("TargetPlayer")
            if p and p.Parent then
                local isValid, _ = ValidateCharacter(p.Character)
                local statusIcon = isValid and "üü¢" or "üî¥"
                local newText = string.format("%s %s (@%s)", statusIcon, p.DisplayName, p.Name)
                local newColor = isValid and Color3.fromRGB(45, 70, 45) or Color3.fromRGB(70, 45, 45)

                -- Hanya update jika ada perubahan status untuk mengurangi pekerjaan
                if button.Text ~= newText then
                    button.Text = newText
                    button.BackgroundColor3 = newColor
                end
            else 
                -- Jika pemain keluar, sembunyikan tombol dan tandai untuk update penuh
                button.Visible = false
                button:SetAttribute("TargetPlayer", nil)
                needsLayoutUpdate = true
            end
        end
    end

    if needsLayoutUpdate then
        -- Jika ada pemain yang keluar, lakukan update penuh untuk menyusun ulang daftar
        task.defer(FullUpdatePlayerList, SearchBox.Text)
    end
end

--// Fungsi Teleport (Tidak ada perubahan signifikan dari v2.2, sudah cukup robust)
local function AdvancedTeleportToPlayer(targetPlayer)
    -- ... (Kode teleport dari v2.2 disalin ke sini) ...
    if teleportCooldown then
        ShowStatus("Cooldown " .. CONFIG.COOLDOWN_TIME .. " detik.", Color3.fromRGB(255, 200, 0), 2)
        return
    end
    local isValid, message, localRoot, localHumanoid = ValidateCharacter(Player.Character, "Anda")
    if not isValid then
        ShowStatus(message, Color3.fromRGB(255, 100, 100), 3, true)
        return
    end
    if localHumanoid.Sit then
        localHumanoid.Sit = false
        ShowStatus("Anda sedang duduk, otomatis berdiri...", Color3.fromRGB(150, 200, 255), 1.5)
        task.wait(0.2)
    end
    if not targetPlayer or not targetPlayer.Parent then
        ShowStatus("Target pemain sudah keluar.", Color3.fromRGB(255, 100, 100), 3, true)
        return
    end
    teleportCooldown = true
    task.delay(CONFIG.COOLDOWN_TIME, function() teleportCooldown = false end)
    local attempts = 0
    local success = false
    ShowStatus(string.format("Mencari %s...", targetPlayer.DisplayName), Color3.fromRGB(255, 255, 100), 2)
    while attempts < CONFIG.MAX_TELEPORT_ATTEMPTS and not success do
        attempts = attempts + 1
        local isTargetValid, targetMessage, targetRoot, targetHumanoid = ValidateCharacter(targetPlayer.Character, targetPlayer.DisplayName)
        if not isTargetValid then
            ShowStatus(string.format("Gagal (%d): %s", attempts, targetMessage), Color3.fromRGB(255, 150, 0), 2)
            task.wait(CONFIG.TELEPORT_RETRY_DELAY)
            continue
        end
        if targetHumanoid:GetState() == Enum.HumanoidStateType.Freefall then
            ShowStatus(string.format("Gagal (%d): %s sedang jatuh.", attempts, targetPlayer.DisplayName), Color3.fromRGB(255, 150, 0), 2)
            task.wait(CONFIG.TELEPORT_RETRY_DELAY)
            continue
        end
        local teleportSuccess, err = pcall(function()
            local targetCFrame = targetRoot.CFrame
            local randomOffset = Vector3.new(math.random(-CONFIG.RANDOM_HORIZONTAL_OFFSET, CONFIG.RANDOM_HORIZONTAL_OFFSET), 0, math.random(-CONFIG.RANDOM_HORIZONTAL_OFFSET, CONFIG.RANDOM_HORIZONTAL_OFFSET))
            localRoot.CFrame = targetCFrame + CONFIG.TELEPORT_OFFSET + randomOffset
            task.wait()
            local distance = (localRoot.Position - targetRoot.Position).Magnitude
            if distance > CONFIG.POST_TELEPORT_VERIFICATION_DISTANCE then
                error("Verifikasi jarak gagal. Jarak: " .. math.floor(distance))
            end
        end)
        if teleportSuccess then
            success = true
            ShowStatus(string.format("‚ú® Berhasil teleport ke %s! (Percobaan %d)", targetPlayer.DisplayName, attempts), Color3.fromRGB(100, 255, 100), 4)
        else
            ShowStatus(string.format("Gagal (%d): %s. Mencoba lagi...", attempts, tostring(err)), Color3.fromRGB(255, 200, 0), 1)
            task.wait(CONFIG.TELEPORT_RETRY_DELAY)
        end
    end
    if not success then
        ShowStatus(string.format("Teleport gagal total ke %s setelah %d percobaan.", targetPlayer.DisplayName, CONFIG.MAX_TELEPORT_ATTEMPTS), Color3.fromRGB(255, 100, 100), 5, true)
    end
end

local function GetPlayerFromName(name) -- Helper function
    for _, p in ipairs(Players:GetPlayers()) do
        if p.Name:lower() == name:lower() or p.DisplayName:lower() == name:lower() then
            return p
        end
    end
    return nil
end

--// Event Connections
SearchBox:GetPropertyChangedSignal("Text"):Connect(function()
    local searchText = SearchBox.Text
    if searchDebounceThread then task.cancel(searchDebounceThread) end
    searchDebounceThread = task.delay(searchDebounceTime, function()
        if SearchBox and SearchBox.Text == searchText then
            FullUpdatePlayerList(searchText)
        end
    end)
end)

TeleportButton.MouseButton1Click:Connect(function()
    local targetName = SearchBox.Text:gsub("%s+", "")
    if targetName == "" then
        ShowStatus("Masukkan nama pemain atau pilih dari list", Color3.fromRGB(255, 150, 0), 3)
        return
    end
    local targetPlayer = GetPlayerFromName(targetName)
    if targetPlayer then
        AdvancedTeleportToPlayer(targetPlayer)
    else
        ShowStatus(string.format("Pemain '%s' tidak ditemukan", targetName), Color3.fromRGB(255, 100, 100), 4, true)
    end
end)

RefreshButton.MouseButton1Click:Connect(function()
    lastSearchQuery = nil -- Paksa update penuh
    FullUpdatePlayerList(SearchBox.Text)
    ShowStatus("Daftar pemain diperbarui", Color3.fromRGB(100, 255, 100), 2)
end)

--// Auto-update system (Sekarang menjalankan update ringan)
local function StartAutoUpdate()
    if updateLoopThread then task.cancel(updateLoopThread) end
    updateLoopThread = task.spawn(function()
        while MainFrame.Parent do
            task.wait(CONFIG.LIGHT_REFRESH_INTERVAL)
            LightUpdatePlayerStatus()
        end
    end)
end

--// Player events (Sekarang memanggil update penuh)
Players.PlayerAdded:Connect(function(player)
    task.wait(1) 
    FullUpdatePlayerList(SearchBox.Text)
    ShowStatus(string.format("üéÆ %s bergabung", player.DisplayName), Color3.fromRGB(100, 255, 100), 3)
end)

Players.PlayerRemoving:Connect(function(player)
    FullUpdatePlayerList(SearchBox.Text)
    ShowStatus(string.format("üëã %s keluar", player.DisplayName), Color3.fromRGB(255, 200, 100), 3)
end)

--// Initialize
PreCreatePlayerButtons() -- Buat kolam tombol
FullUpdatePlayerList("") -- Lakukan update penuh pertama kali
StartAutoUpdate()      -- Mulai loop update ringan

print("üöÄ Advanced Teleport GUI v2.3 (Performance Edition) loaded!")
ShowStatus("GUI siap! Dioptimalkan untuk mobile.", Color3.fromRGB(100, 255, 100), 6)