-- LocalScript (ESP v11 - Ultra Minimalist / Clean Look)
-- Gaya "Valorant Style": Tanpa Kotak Background Besar, Teks Rapi, Bar Tipis

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local StarterGui = game:GetService("StarterGui")

local LocalPlayer = Players.LocalPlayer
local LocalCamera = Workspace.CurrentCamera
local MASTER_ENABLED = true

-- ============== CONFIG MODERN (MINIMALIS) ==============
local CONFIG = {
	-- Jarak Pandang
	MAX_RENDER_DIST = 2500, -- Highlight render
	MAX_TEXT_DIST = 1000,   -- Teks render (supaya layar gak penuh tulisan)

	-- Visual Setting
	TEXT_SIZE_NAME = 12,    -- Font Nama (Kecil tapi jelas)
	TEXT_SIZE_DIST = 10,    -- Font Jarak (Lebih kecil)
	FONT = Enum.Font.GothamBold,
	
	-- Warna
	COLOR_ENEMY = Color3.fromRGB(255, 65, 65),     -- Merah
	COLOR_TEAM = Color3.fromRGB(0, 255, 140),      -- Cyan/Hijau
	COLOR_BAR_BG = Color3.fromRGB(30, 30, 30),     -- Background bar darah
	
	-- Posisi (Offset)
	OFFSET_HEIGHT = Vector3.new(0, 2.5, 0), -- Melayang pas di atas kepala
}

local tracked = {}

local function isValid(obj) return obj and obj.Parent end

-- === FUNGSI MEMBUAT UI MINIMALIS ===
local function createCleanESP()
	-- 1. Main Container (Invisible)
	local bb = Instance.new("BillboardGui")
	bb.Name = "ESP_Clean"
	bb.Size = UDim2.new(0, 200, 0, 50) -- Area render
	bb.StudsOffset = CONFIG.OFFSET_HEIGHT
	bb.AlwaysOnTop = true
	bb.MaxDistance = CONFIG.MAX_TEXT_DIST

	-- Container agar rapi (tengah)
	local container = Instance.new("Frame")
	container.BackgroundTransparency = 1 -- TRANSPARAN TOTAL (Hilangkan kotak)
	container.Size = UDim2.fromScale(1, 1)
	container.Parent = bb

	-- 2. Teks Nama (Dengan Outline)
	local nameTxt = Instance.new("TextLabel")
	nameTxt.Parent = container
	nameTxt.Name = "Name"
	nameTxt.BackgroundTransparency = 1
	nameTxt.Position = UDim2.new(0, 0, 0.2, 0)
	nameTxt.Size = UDim2.new(1, 0, 0.3, 0)
	nameTxt.Font = CONFIG.FONT
	nameTxt.Text = "Username"
	nameTxt.TextColor3 = Color3.new(1,1,1)
	nameTxt.TextSize = CONFIG.TEXT_SIZE_NAME
	nameTxt.TextYAlignment = Enum.TextYAlignment.Bottom
	-- Stroke Penting agar terbaca tanpa background
	local stroke = Instance.new("UIStroke")
	stroke.Color = Color3.new(0,0,0)
	stroke.Thickness = 1.5
	stroke.Transparency = 0 -- Hitam pekat
	stroke.Parent = nameTxt

	-- 3. Health Bar Background (Tipis Banget)
	local hpBg = Instance.new("Frame")
	hpBg.Name = "HP_BG"
	hpBg.Parent = container
	hpBg.BackgroundColor3 = CONFIG.COLOR_BAR_BG
	hpBg.BorderSizePixel = 0
	hpBg.AnchorPoint = Vector2.new(0.5, 0)
	hpBg.Position = UDim2.new(0.5, 0, 0.52, 0) -- Di bawah nama persis
	hpBg.Size = UDim2.new(0, 30, 0, 3) -- Lebar cuma 30px, Tinggi 3px
	
	-- Rounding HP Bar
	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(1,0)
	corner.Parent = hpBg

	-- 4. Health Bar Fill
	local hpFill = Instance.new("Frame")
	hpFill.Name = "HP_Fill"
	hpFill.Parent = hpBg
	hpFill.BackgroundColor3 = CONFIG.COLOR_TEAM
	hpFill.BorderSizePixel = 0
	hpFill.Size = UDim2.fromScale(1, 1)
	local corner2 = Instance.new("UICorner")
	corner2.CornerRadius = UDim.new(1,0)
	corner2.Parent = hpFill

	-- 5. Teks Jarak (Paling bawah, kecil)
	local distTxt = Instance.new("TextLabel")
	distTxt.Parent = container
	distTxt.BackgroundTransparency = 1
	distTxt.Position = UDim2.new(0, 0, 0.6, 0) -- Di bawah bar darah
	distTxt.Size = UDim2.new(1, 0, 0.2, 0)
	distTxt.Font = Enum.Font.GothamMedium
	distTxt.Text = "100m"
	distTxt.TextColor3 = Color3.fromRGB(220, 220, 220) -- Putih agak abu
	distTxt.TextSize = CONFIG.TEXT_SIZE_DIST
	distTxt.TextYAlignment = Enum.TextYAlignment.Top
	local stroke2 = stroke:Clone()
	stroke2.Thickness = 1
	stroke2.Parent = distTxt

	return bb, nameTxt, distTxt, hpFill
end

local function getTeamColor(p)
	if p == LocalPlayer then return nil end
	-- Team Logic Simple
	if LocalPlayer.Team and p.Team and LocalPlayer.Team == p.Team then
		return CONFIG.COLOR_TEAM
	end
	return CONFIG.COLOR_ENEMY
end

-- === PLAYER LOGIC ===

local function cleanup(p)
	if tracked[p] then
		if tracked[p].bb then tracked[p].bb:Destroy() end
		if tracked[p].hl then tracked[p].hl:Destroy() end
		tracked[p] = nil
	end
end

local function updateESP()
	local camPos = LocalCamera.CFrame.Position

	for p, data in pairs(tracked) do
		-- Safety check
		if not p.Parent then cleanup(p) continue end
		
		local char = p.Character
		if not char or not char:FindFirstChild("Head") or not char:FindFirstChild("HumanoidRootPart") then
			if data.bb then data.bb.Enabled = false end
			if data.hl then data.hl.Enabled = false end
			continue
		end

		local hum = char:FindFirstChild("Humanoid")
		if not hum or hum.Health <= 0 then
			if data.bb then data.bb.Enabled = false end
			if data.hl then data.hl.Enabled = false end
			continue
		end

		local dist = (char.HumanoidRootPart.Position - camPos).Magnitude

		if not MASTER_ENABLED then
			if data.bb then data.bb.Enabled = false end
			if data.hl then data.hl.Enabled = false end
			continue
		end

		-- LOGIC RENDER
		if dist < CONFIG.MAX_RENDER_DIST then
			local color = getTeamColor(p)

			-- 1. SETUP UI JIKA BELUM ADA
			if not data.bb then
				local bb, n, d, h = createCleanESP()
				bb.Adornee = char.Head
				bb.Parent = char.Head
				
				-- Highlight
				local hl = Instance.new("Highlight")
				hl.Adornee = char
				hl.FillTransparency = 0.6
				hl.OutlineTransparency = 0.2
				hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
				hl.Parent = char

				tracked[p] = { bb = bb, name = n, dist = d, bar = h, hl = hl }
				data = tracked[p] -- update local var
			end

			data.bb.Enabled = (dist < CONFIG.MAX_TEXT_DIST)
			data.hl.Enabled = true

			-- 2. UPDATE INFO (Loop ringan)
			-- Update Warna Highlight
			data.hl.FillColor = color
			data.hl.OutlineColor = Color3.new(1,1,1)

			-- Update Text Nama
			data.name.Text = p.DisplayName
			-- (Opsional: nama warnanya mengikuti tim/musuh atau putih aja)
			-- data.name.TextColor3 = color 
			
			-- Update Health Bar (Warna berubah merah kalau sekarat)
			local healthPerc = math.clamp(hum.Health / hum.MaxHealth, 0, 1)
			data.bar.Size = UDim2.new(healthPerc, 0, 1, 0)
			
			-- Gradasi warna darah (Hijau -> Kuning -> Merah)
			local r = math.clamp((1 - healthPerc) * 2, 0, 1)
			local g = math.clamp(healthPerc * 2, 0, 1)
			data.bar.BackgroundColor3 = Color3.new(1, g, 0):Lerp(Color3.new(r, 0, 0), 0)
			if healthPerc > 0.5 then
				data.bar.BackgroundColor3 = Color3.new((1-healthPerc)*2, 1, 0)
			else
				data.bar.BackgroundColor3 = Color3.new(1, healthPerc*2, 0)
			end
			-- Warna simple (Team based):
			-- data.bar.BackgroundColor3 = color

			-- Update Jarak
			data.dist.Text = string.format("%d m", math.floor(dist))

		else
			-- Jauh
			if data.bb then data.bb.Enabled = false end
			if data.hl then data.hl.Enabled = false end
		end
	end
end

-- Init loop
RunService.Heartbeat:Connect(updateESP)
Players.PlayerAdded:Connect(function(p) tracked[p] = {} end)
Players.PlayerRemoving:Connect(cleanup)
for _, p in ipairs(Players:GetPlayers()) do if p ~= LocalPlayer then tracked[p] = {} end end

-- Chat Cmds
LocalPlayer.Chatted:Connect(function(msg)
	if msg:lower() == "/espoff" then MASTER_ENABLED = false end
	if msg:lower() == "/espon" then MASTER_ENABLED = true end
end)

-- Notif
StarterGui:SetCore("SendNotification", {Title="ESP Clean v11", Text="Loaded!", Duration=2})
