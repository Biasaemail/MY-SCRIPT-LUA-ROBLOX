-- [[ Skrip Advanced Teleport v2.2 - Diperbaiki oleh Gemini & AI Assistant ]]

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

--// Variables
local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local searchDebounceTime = 0.15
local searchDebounceThread = nil
local selectedPlayerName = nil
local teleportCooldown = false
local lastSearchQuery = nil
local cachedPlayers = {}
local updateConnection = nil

--// Configuration
local CONFIG = {
    TELEPORT_OFFSET = Vector3.new(0, 4, 0), -- Offset saat teleport (sedikit dikurangi)
    MAX_TELEPORT_ATTEMPTS = 5,
    TELEPORT_RETRY_DELAY = 0.1,
    SEARCH_MIN_LENGTH = 1,
    COOLDOWN_TIME = 0.1, -- Cooldown 1 detik
    TOGGLE_KEY = Enum.KeyCode.F9 -- Hotkey untuk menampilkan/menyembunyikan GUI
}

--// GUI Creation
local ScreenGui = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
local UICorner = Instance.new("UICorner")
local UIAspectRatioConstraint = Instance.new("UIAspectRatioConstraint") -- [[ PERBAIKAN 1: Menjaga rasio GUI ]]
local Title = Instance.new("TextLabel")
local SearchBox = Instance.new("TextBox")
local PlayerList = Instance.new("ScrollingFrame")
local UIListLayout = Instance.new("UIListLayout")
local TeleportButton = Instance.new("TextButton")
local StatusLabel = Instance.new("TextLabel")
local RefreshButton = Instance.new("TextButton")
local ToggleButton = Instance.new("TextButton") -- [[ PENINGKATAN: Tombol Toggle ]]

-- GUI Setup
ScreenGui.Name = "AdvancedTeleportGUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- [[ PERBAIKAN 1: Tombol untuk menyembunyikan/menampilkan GUI ]]
ToggleButton.Name = "ToggleButton"
ToggleButton.Parent = ScreenGui
ToggleButton.Size = UDim2.new(0, 100, 0, 30)
ToggleButton.Position = UDim2.new(1, -110, 0, 10)
ToggleButton.AnchorPoint = Vector2.new(1, 0)
ToggleButton.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
ToggleButton.Font = Enum.Font.GothamBold
ToggleButton.Text = "Teleport (F9)"
ToggleButton.TextColor3 = Color3.fromRGB(100, 200, 255)
ToggleButton.TextSize = 14
local toggleCorner = Instance.new("UICorner")
toggleCorner.CornerRadius = UDim.new(0, 6)
toggleCorner.Parent = ToggleButton

MainFrame.Name = "MainFrame"
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
-- [[ PERBAIKAN 1: Menggunakan Scale agar responsif di semua perangkat ]]
MainFrame.Size = UDim2.new(0.35, 0, 0.5, 0) -- 35% lebar layar, 50% tinggi layar
MainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
MainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Visible = true -- Defaultnya terlihat

-- [[ PERBAIKAN 1: Menjaga aspek rasio agar tidak terlalu lebar/pipih di layar berbeda ]]
UIAspectRatioConstraint.Parent = MainFrame
UIAspectRatioConstraint.AspectRatio = 1.0 -- Bentuk persegi (lebar = tinggi)
UIAspectRatioConstraint.DominantAxis = Enum.DominantAxis.Height -- Ukuran akan mengikuti tinggi frame

UICorner.Parent = MainFrame
UICorner.CornerRadius = UDim.new(0, 10)

-- (Sisa properti GUI lainnya disesuaikan agar pas dengan layout baru, tidak perlu diubah manual)
Title.Name = "Title"; Title.Parent = MainFrame; Title.BackgroundTransparency = 1; Title.Position = UDim2.new(0, 0, 0.02, 0); Title.Size = UDim2.new(1, 0, 0.08, 0); Title.Font = Enum.Font.GothamBold; Title.Text = "🚀 Adv Teleport"; Title.TextColor3 = Color3.fromRGB(100, 200, 255); Title.TextSize = 18;
SearchBox.Name = "SearchBox"; SearchBox.Parent = MainFrame; SearchBox.BackgroundColor3 = Color3.fromRGB(40, 40, 40); SearchBox.Position = UDim2.new(0.05, 0, 0.12, 0); SearchBox.Size = UDim2.new(0.75, 0, 0.08, 0); SearchBox.Font = Enum.Font.Gotham; SearchBox.PlaceholderText = "🔍 Cari pemain..."; SearchBox.Text = ""; SearchBox.TextColor3 = Color3.fromRGB(255, 255, 255); SearchBox.TextSize = 14; SearchBox.ClearTextOnFocus = true; local searchBoxCorner = Instance.new("UICorner"); searchBoxCorner.CornerRadius = UDim.new(0, 6); searchBoxCorner.Parent = SearchBox;
RefreshButton.Name = "RefreshButton"; RefreshButton.Parent = MainFrame; RefreshButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60); RefreshButton.Position = UDim2.new(0.82, 0, 0.12, 0); RefreshButton.Size = UDim2.new(0.13, 0, 0.08, 0); RefreshButton.Font = Enum.Font.GothamBold; RefreshButton.Text = "🔄"; RefreshButton.TextColor3 = Color3.fromRGB(255, 255, 255); RefreshButton.TextSize = 16; local refreshBtnCorner = Instance.new("UICorner"); refreshBtnCorner.CornerRadius = UDim.new(0, 6); refreshBtnCorner.Parent = RefreshButton;
PlayerList.Name = "PlayerList"; PlayerList.Parent = MainFrame; PlayerList.BackgroundColor3 = Color3.fromRGB(35, 35, 35); PlayerList.Position = UDim2.new(0.05, 0, 0.22, 0); PlayerList.Size = UDim2.new(0.9, 0, 0.5, 0); PlayerList.CanvasSize = UDim2.new(0, 0, 0, 0); PlayerList.ScrollBarThickness = 6; PlayerList.ScrollingEnabled = true; PlayerList.BorderSizePixel = 0; local playerListCorner = Instance.new("UICorner"); playerListCorner.CornerRadius = UDim.new(0, 8); playerListCorner.Parent = PlayerList;
UIListLayout.Parent = PlayerList; UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder; UIListLayout.Padding = UDim.new(0, 3);
TeleportButton.Name = "TeleportButton"; TeleportButton.Parent = MainFrame; TeleportButton.BackgroundColor3 = Color3.fromRGB(0, 150, 255); TeleportButton.Position = UDim2.new(0.05, 0, 0.74, 0); TeleportButton.Size = UDim2.new(0.9, 0, 0.1, 0); TeleportButton.Font = Enum.Font.GothamBold; TeleportButton.Text = "🎯 TELEPORT"; TeleportButton.TextColor3 = Color3.fromRGB(255, 255, 255); TeleportButton.TextSize = 16; local teleportBtnCorner = Instance.new("UICorner"); teleportBtnCorner.CornerRadius = UDim.new(0, 8); teleportBtnCorner.Parent = TeleportButton;
StatusLabel.Name = "StatusLabel"; StatusLabel.Parent = MainFrame; StatusLabel.BackgroundTransparency = 1; StatusLabel.Position = UDim2.new(0.05, 0, 0.86, 0); StatusLabel.Size = UDim2.new(0.9, 0, 0.12, 0); StatusLabel.Font = Enum.Font.Gotham; StatusLabel.Text = "✅ GUI siap"; StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100); StatusLabel.TextSize = 12; StatusLabel.TextWrapped = true; StatusLabel.TextYAlignment = Enum.TextYAlignment.Top;

ScreenGui.Parent = PlayerGui

--// Utility Functions
local function ShowStatus(message, color, duration, isError)
    local prefix = isError and "❌ " or (color == Color3.fromRGB(100, 255, 100) and "✅ " or "ℹ️ ")
    StatusLabel.Text = prefix .. message
    StatusLabel.TextColor3 = color or Color3.fromRGB(255, 255, 255)
    
    task.delay(duration or 4, function()
        if StatusLabel and StatusLabel.Text == (prefix .. message) then
            StatusLabel.Text = "⏳ Menunggu aksi..."
            StatusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
        end
    end)
end

local function AdvancedGetPlayer(searchTerm)
    if not searchTerm or searchTerm == "" then return nil end
    searchTerm = searchTerm:lower():gsub("%s+", "")
    local results = {}
    for _, playerObj in ipairs(Players:GetPlayers()) do
        if playerObj ~= Player then
            local name = playerObj.Name:lower():gsub("%s+", "")
            local displayName = playerObj.DisplayName:lower():gsub("%s+", "")
            if name == searchTerm or displayName == searchTerm then return playerObj end
            if name:match("^" .. searchTerm) or displayName:match("^" .. searchTerm) then table.insert(results, {player = playerObj, priority = 1})
            elseif name:match(searchTerm) or displayName:match(searchTerm) then table.insert(results, {player = playerObj, priority = 2}) end
        end
    end
    if #results > 0 then
        table.sort(results, function(a, b) return a.priority < b.priority end)
        return results[1].player
    end
    return nil
end

local function ValidatePlayer(targetPlayer)
    if not targetPlayer then return false, "Player tidak ditemukan" end
    if not targetPlayer.Parent then return false, "Player sudah keluar" end
    if targetPlayer == Player then return false, "Tidak bisa ke diri sendiri" end
    return true, "Player valid"
end

-- [[ PERBAIKAN 3: Logika validasi karakter dengan fallback ]]
local function ValidateCharacter(character, playerName)
    if not character or not character.Parent then
        return false, playerName .. " belum spawn atau tidak valid"
    end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid or humanoid.Health <= 0 then
        return false, playerName .. " sudah mati atau tidak memiliki humanoid"
    end
    
    -- Mencari root part utama, dengan fallback ke Torso/UpperTorso
    local rootPart = character:FindFirstChild("HumanoidRootPart") 
        or character:FindFirstChild("UpperTorso") -- R15 Fallback
        or character:FindFirstChild("Torso") -- R6 Fallback
        
    if not rootPart then
        return false, playerName .. " tidak memiliki bagian tubuh utama (RootPart/Torso)"
    end
    
    return true, "Character valid", rootPart, humanoid
end

--// Core Functions
local function UpdatePlayerList(searchText)
	local currentSearchText = searchText or ""
    if currentSearchText == lastSearchQuery and currentSearchText ~= "" then return end
    lastSearchQuery = currentSearchText
    
    local lowerSearchText = currentSearchText:lower()
    
    for _, child in ipairs(PlayerList:GetChildren()) do
        if child:IsA("TextButton") then child:Destroy() end
    end

    local playersToShow = {}
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= Player then
            local name, displayName = p.Name:lower(), p.DisplayName:lower()
            if lowerSearchText == "" or name:match(lowerSearchText) or displayName:match(lowerSearchText) then
                local isValid, _, _, humanoid = ValidateCharacter(p.Character, p.Name)
                table.insert(playersToShow, {
                    player = p,
                    hasValidChar = isValid,
                    ping = p:GetNetworkPing() * 1000
                })
            end
        end
    end

    table.sort(playersToShow, function(a, b)
        if a.hasValidChar ~= b.hasValidChar then return a.hasValidChar end
        return a.player.DisplayName:lower() < b.player.DisplayName:lower()
    end)

    for _, data in ipairs(playersToShow) do
        local p = data.player
        local playerButton = Instance.new("TextButton")
        local statusIcon = data.hasValidChar and "🟢" or "🔴"
        local pingText = math.floor(data.ping) .. "ms"
        
        playerButton.Size = UDim2.new(1, -8, 0, 30)
        playerButton.BackgroundColor3 = data.hasValidChar and Color3.fromRGB(45, 70, 45) or Color3.fromRGB(70, 45, 45)
        playerButton.Text = string.format("%s %s (@%s) - %s", statusIcon, p.DisplayName, p.Name, pingText)
        playerButton.TextColor3 = Color3.fromRGB(255, 255, 255); playerButton.TextSize = 13; playerButton.Font = Enum.Font.Gotham; playerButton.TextXAlignment = Enum.TextXAlignment.Left; playerButton.Parent = PlayerList;
        local btnCorner = Instance.new("UICorner"); btnCorner.CornerRadius = UDim.new(0, 6); btnCorner.Parent = playerButton;

        playerButton.MouseEnter:Connect(function() TweenService:Create(playerButton, TweenInfo.new(0.15), {BackgroundColor3 = playerButton.BackgroundColor3:Lerp(Color3.new(1,1,1), 0.15)}):Play() end)
        playerButton.MouseLeave:Connect(function() TweenService:Create(playerButton, TweenInfo.new(0.15), {BackgroundColor3 = data.hasValidChar and Color3.fromRGB(45, 70, 45) or Color3.fromRGB(70, 45, 45)}):Play() end)

        playerButton.MouseButton1Click:Connect(function()
            SearchBox.Text = p.Name
            selectedPlayerName = p.Name
            ShowStatus(string.format("Target: %s (%s)", p.DisplayName, data.hasValidChar and "Ready" or "Not Ready"), Color3.fromRGB(150, 200, 255), 2)
        end)
    end
    
    PlayerList.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y + 10)
end

-- [[ PERBAIKAN 2: Teleport dengan pengecekan atap (Raycast) ]]
local function AdvancedTeleportToPlayer(targetPlayer)
    if teleportCooldown then
        ShowStatus("Tunggu " .. CONFIG.COOLDOWN_TIME .. " detik", Color3.fromRGB(255, 200, 0), 2)
        return
    end
    
    local isValid, message, localRoot, localHumanoid = ValidateCharacter(Player.Character, "Anda")
    if not isValid then
        ShowStatus(message, Color3.fromRGB(255, 100, 100), 3, true)
        return
    end
    
    if localHumanoid.Sit then
        localHumanoid.Sit = false
        ShowStatus("ℹ️ Anda sedang duduk, otomatis berdiri...", Color3.fromRGB(150, 200, 255), 1.5)
        task.wait(0.2)
    end
    
    local isPlayerValid, playerMessage = ValidatePlayer(targetPlayer)
    if not isPlayerValid then
        ShowStatus(playerMessage, Color3.fromRGB(255, 100, 100), 3, true)
        return
    end
    
    teleportCooldown = true
    task.delay(CONFIG.COOLDOWN_TIME, function() teleportCooldown = false end)
    
    local attempts = 0
    local success = false
    
    ShowStatus(string.format("Memulai teleportasi ke %s...", targetPlayer.DisplayName), Color3.fromRGB(255, 255, 100), 2)
    
    while attempts < CONFIG.MAX_TELEPORT_ATTEMPTS and not success do
        attempts = attempts + 1
        
        local isTargetValid, targetMessage, targetRoot = ValidateCharacter(targetPlayer.Character, targetPlayer.DisplayName)
        
        if not isTargetValid then
            ShowStatus(string.format("Gagal %d: %s", attempts, targetMessage), Color3.fromRGB(255, 150, 0), 2)
            task.wait(CONFIG.TELEPORT_RETRY_DELAY)
            continue
        end
        
        local teleportSuccess = pcall(function()
            local targetPos = targetRoot.Position
            local finalCFrame
            
            -- Raycast setup untuk mendeteksi atap/penghalang
            local rayOrigin = targetPos
            local rayDirection = Vector3.new(0, 15, 0) -- Tembak sinar 15 stud ke atas
            local raycastParams = RaycastParams.new()
            raycastParams.FilterType = Enum.RaycastFilterType.Exclude
            raycastParams.FilterDescendantsInstances = {Player.Character, targetPlayer.Character}
            
            local rayResult = workspace:Raycast(rayOrigin, rayDirection, raycastParams)
            
            if rayResult then
                -- Ada penghalang, teleport di bawahnya
                local safePosition = rayResult.Position - Vector3.new(0, 3, 0) -- 3 stud di bawah titik tumbukan
                finalCFrame = CFrame.new(safePosition)
                ShowStatus("ℹ️ Penghalang terdeteksi, teleportasi disesuaikan.", Color3.fromRGB(150, 200, 255), 2)
            else
                -- Tidak ada penghalang, teleport di atas kepala
                finalCFrame = targetRoot.CFrame + CONFIG.TELEPORT_OFFSET
            end
            
            localRoot.CFrame = finalCFrame
            
            task.wait(0.1)
            if (localRoot.Position - targetRoot.Position).Magnitude > 50 then
                error("Jarak teleport terlalu jauh, mungkin gagal.")
            end
        end)
        
        if teleportSuccess then
            success = true
            ShowStatus(string.format("✨ Berhasil teleport ke %s! (Coba ke-%d)", targetPlayer.DisplayName, attempts), Color3.fromRGB(100, 255, 100), 4)
        else
            ShowStatus(string.format("Gagal coba ke-%d, mencoba lagi...", attempts), Color3.fromRGB(255, 200, 0), 1)
            task.wait(CONFIG.TELEPORT_RETRY_DELAY)
        end
    end
    
    if not success then
        ShowStatus(string.format("❌ Gagal teleport ke %s setelah %d percobaan", targetPlayer.DisplayName, CONFIG.MAX_TELEPORT_ATTEMPTS), Color3.fromRGB(255, 100, 100), 5, true)
    end
end

--// Event Connections
SearchBox:GetPropertyChangedSignal("Text"):Connect(function()
    local searchText = SearchBox.Text
    if searchDebounceThread then task.cancel(searchDebounceThread) end
    searchDebounceThread = task.delay(searchDebounceTime, function()
        if SearchBox and SearchBox.Text == searchText then UpdatePlayerList(searchText) end
        searchDebounceThread = nil
    end)
end)

TeleportButton.MouseButton1Click:Connect(function()
    local targetName = SearchBox.Text:gsub("%s+", "")
    if targetName == "" then
        ShowStatus("Masukkan nama pemain atau pilih dari list", Color3.fromRGB(255, 150, 0), 3)
        return
    end
    local targetPlayer = AdvancedGetPlayer(targetName)
    if targetPlayer then AdvancedTeleportToPlayer(targetPlayer)
    else ShowStatus(string.format("Pemain '%s' tidak ditemukan", targetName), Color3.fromRGB(255, 100, 100), 4, true) end
end)

RefreshButton.MouseButton1Click:Connect(function()
    lastSearchQuery = nil
    UpdatePlayerList(SearchBox.Text)
    ShowStatus("📋 Daftar pemain diperbarui", Color3.fromRGB(100, 255, 100), 2)
end)

-- [[ PENINGKATAN: Logika untuk tombol toggle ]]
ToggleButton.MouseButton1Click:Connect(function()
    MainFrame.Visible = not MainFrame.Visible
end)

--// Auto-update & Player Events
task.spawn(function()
    while task.wait(5) do -- Refresh daftar pemain setiap 5 detik
        if MainFrame.Visible then -- Hanya update jika GUI terlihat untuk efisiensi
            UpdatePlayerList(SearchBox.Text)
        end
    end
end)

Players.PlayerAdded:Connect(function(player)
    task.wait(1) 
    UpdatePlayerList(SearchBox.Text)
    ShowStatus(string.format("🎮 %s bergabung", player.DisplayName), Color3.fromRGB(100, 255, 100), 3)
end)

Players.PlayerRemoving:Connect(function(player)
    if SearchBox.Text:lower() == player.Name:lower() then SearchBox.Text = "" end
    UpdatePlayerList(SearchBox.Text)
    ShowStatus(string.format("👋 %s keluar", player.DisplayName), Color3.fromRGB(255, 200, 100), 3)
end)

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.Return or input.KeyCode == Enum.KeyCode.KeypadEnter then
        if SearchBox:IsFocused() then TeleportButton.MouseButton1Click:Fire() end
    elseif input.KeyCode == Enum.KeyCode.F5 then
        RefreshButton.MouseButton1Click:Fire()
    elseif input.KeyCode == CONFIG.TOGGLE_KEY then -- [[ PENINGKATAN: Hotkey toggle ]]
        ToggleButton.MouseButton1Click:Fire()
    end
end)

--// Initialize
UpdatePlayerList("")
print("🚀 Advanced Teleport GUI v2.2 loaded successfully!")
ShowStatus(string.format("🎯 GUI siap! Tekan %s untuk toggle", CONFIG.TOGGLE_KEY.Name), Color3.fromRGB(100, 255, 100), 6)
